#!/bin/bash
#SBATCH --job-name=expIII_icmd
#SBATCH --output=%x_%A_%a.out # create output files indexed with the job array task id
#SBATCH --partition=prepost  #cpu_p1
#SBATCH --time=05:00:00   # DMLE, ICM-D: 2h, CA: 30min, ICM-P: 18h (max)
#SBATCH --qos=qos_cpu-t3   #qos_cpu-dev
#SBATCH --hint=nomultithread 
#SBATCH --nodes=1          
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=1  ############################  2 for CA, 3 for ICM-P on cpu_p1, 1 on prepost
#SBATCH --array=16,18,20,22,23,26,27,32,33,35,36,37,38,40,44,45,46,47,48,50,52,53,54,56,57,58,59,60,62,67,70,72,74,75,76,77,79,81,82,83,84,86,87,88,89,90,91,92,93,96,97,103,104,105,107,110,111,114,115,117,118,119,121,123,124,125,127,128,129,130,134,137,141,144,147,149,150,151,152,154,157,158,159,160,162,164,165,166,167,169,315,470,483,484,485,486,488,489,491,493,495,496,498,500,501,502,503,504,505,508,509,511,512,513,514,516,519,520,521,522,523,524,525,526,527,529,530,531,532,533,534,535,536,537,538,539,540,541,542,544,545,549,551,554,558,560,561,562,563,564,570,571,572,574,578,579,581,582,583,584,587,588,591,592,594,595,597,598,599 #,600,602,605,606,607,608,610,612,613,614,616,618,619,621,622,623,624,625,629,633,636,950,951,952,953,954,956,958,959,962,964,965,967,968,969,970,971,972,973,975,977,979,980,985,986,987,988,989,993,995,996,998,1000,1001,1002,1003,1004,1006,1008,1010,1013,1014,1017,1018,1022,1023,1024,1025,1026,1027,1029,1030,1032,1033,1035,1036,1037,1038,1040,1042,1044,1047,1049,1050,1052,1055,1056,1057,1058,1061,1064,1066,1067,1068,1070,1073,1076,1078,1079,1080,1082,1084,1085,1086,1087,1089,1090,1091,1092,1093,1094,1097,1098,1100,1310,1402,1415,1418,1420,1425,1426,1427,1428,1430,1431,1432,1433,1435,1436,1437,1438,1440,1441,1442,1443,1445,1446,1447,1448,1450,1452,1454,1458,1459,1460,1461,1462,1464,1465,1466,1467,1468,1469,1470,1472,1473,1474,1475,1476,1478,1480,1483,1484,1485,1487,1489,1490,1491,1494,1496,1499,1500,1502,1503,1504,1505,1506,1507,1508,1509,1510,1511,1514,1515,1517,1518,1523,1524,1526,1527,1529,1531,1532,1534,1535,1537,1538,1539,1541,1542,1544,1546,1547,1549,1551,1552,1553,1554,1555,1556,1558,1560,1562,1566,1568,1880,1882,1883,1886,1887,1888,1889,1891,1892,1893,1894,1895,1896,1897,1898,1899,1901,1902,1903,1904,1905,1907,1909,1911,1913,1916,1918,1919,1920,1922,1923,1924,1925,1926,1927,1929,1930,1931,1932,1935,1936,1937,1938,1940,1946,1949,1950,1951,1953,1955,1958,1959,1960,1961,1962,1963,1964,1966,1967,1968,1969,1971,1974,1975,1976,1977,1978,1980,1981,1982,1984,1987,1988,1989,1990,1992,1993,1994,1995,1996,1997,1998,2000,2001,2003,2005,2006,2007,2008,2011,2012,2014,2016,2017,2018,2019,2020,2021,2022,2025,2028,2029,2030,2031,2033,2035,2148,2334,2346,2347,2348,2349,2351,2352,2354,2355,2356,2358,2361,2365,2366,2368,2369,2372,2375,2376,2377,2379,2383,2384,2386,2388,2389,2390,2391,2392,2393,2394,2395,2397,2398,2399,2400,2401,2402,2403,2405,2406,2407,2408,2409,2411,2414,2415,2417,2418,2419,2420,2421,2422,2423,2424,2425,2426,2427,2428,2430,2431,2432,2433,2435,2437,2440,2442,2443,2446,2447,2449,2450,2451,2454,2455,2456,2457,2458,2459,2461,2462,2463,2464,2466,2467,2469,2470,2471,2472,2474,2475,2476,2477,2478,2479,2480,2481,2484,2485,2486,2491,2492,2496,2497,2498,2499,2500,2520,2534,2800,2814,2815,2816,2818,2819,2820,2823,2826,2827,2828,2831,2834,2835,2839,2840,2843,2844,2848,2849,2851,2852,2854,2855,2857,2858,2862,2863,2864,2865,2866,2867,2868,2870,2871,2872,2873,2874,2875,2876,2877,2878,2881,2882,2883,2884,2885,2886,2887,2889,2891,2894,2896,2897,2898,2899,2901,2902,2906,2907,2911,2912,2914,2916,2917,2919,2921,2922,2925,2928,2929,2930,2932,2933,2934,2935,2936,2937,2938,2939,2940,2942,2944,2945,2946,2947,2948,2951,2952,2953,2954,2955,2956,2958,2961,2962,2963,2964,2966,2977,3266,3278,3279,3281,3282,3283,3284,3286,3288,3289,3290,3291,3292,3294,3295,3297,3298,3299,3300,3301,3302,3303,3304,3305,3308,3309,3310,3311,3316,3318,3319,3320,3321,3322,3324,3327,3328,3329,3331,3332,3333,3334,3335,3336,3338,3340,3341,3342,3343,3344,3345,3347,3348,3349,3352,3353,3354,3356,3357,3359,3361,3362,3363,3364,3365,3366,3367,3368,3369,3371,3372,3373,3374,3375,3377,3378,3379,3380,3381,3382,3383,3385,3388,3391,3392,3393,3395,3396,3398,3402,3403,3405,3406,3407,3408,3410,3411,3412,3413,3416,3417,3418,3419,3421,3422,3423,3424,3425,3428,3429,3432,3588,3745,3746,3748,3749,3750,3751,3752,3757,3758,3759,3760,3764,3765,3766,3771,3773,3774,3775,3776,3778,3780,3781,3782,3785,3786,3787,3788,3790,3792,3793,3797,3798,3800,3801,3802,3803,3804,3806,3807,3809,3811,3813,3815,3816,3817,3818,3819,3820,3822,3823,3826,3827,3829,3830,3831,3833,3834,3835,3837,3839,3842,3846,3848,3849,3853,3854,3855,3857,3859,3861,3862,3863,3864,3866,3871,3872,3874,3876,3877,3878,3882,3884,3885,3886,3890,3892,3893,3895,3898,3899,3959,4210,4211,4212,4213,4216,4218,4219,4220,4223,4225,4226,4230,4231,4232,4233,4235,4241,4246,4247,4249,4250,4251,4252,4254,4255,4256,4259,4261,4263,4264,4266,4268,4269,4270,4271,4272,4276,4277,4279,4280,4281,4282,4285,4286,4289,4290,4291,4292,4294,4296,4297,4298,4299,4301,4302,4304,4306,4307,4308,4309,4311,4314,4315,4317,4318,4319,4321,4323,4325,4328,4331,4333,4335,4337,4339,4340,4341,4342,4344,4345,4348,4349,4350,4351,4352,4356,4359,4360,4362,4364,4478,4484    # expI ca, icm-p  # 0-1649 expI icm-d, mle   , expIII: ca, icmp 0-29, mle: 0-4659,
#SBATCH --mail-type=BEGIN
#SBATCH --mail-type=END
#SBATCH --mail-type=FAIL
#SBATCH --mail-user=ioannis.chalkiadakis@cnrs.fr

# grep -H "Convergence: True"  expIII_icmd_* | bash -c 'comm -23 <(seq "$1" "$2") <(sed -n "s/.*_\([0-9]\+\)\.out:.*/\1/p" | sort -n | uniq) | paste -sd, - > output.txt' _ 0 4659




cd ${SLURM_SUBMIT_DIR}

export SRUN_CPUS_PER_TASK=$SLURM_CPUS_PER_TASK
module purge
module load singularity

#index in the csv file of each parameter vector
# slurm_array_task_id=int(os.environ["SLURM_ARRAY_TASK_ID"])

set -x


# time singularity exec --bind $WORK:/linkhome/rech/genpuz01/umi36fq,$WORK/ideal/:/app/repo $SINGULARITY_ALLOWED_DIR/ideal_symblink.sif bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate ideal && python -u /app/repo/idealpestimation/src/icm_annealing_posteriorpower_slurm.py"
time singularity exec --bind $WORK:/linkhome/rech/genpuz01/umi36fq,$WORK/ideal/:/app/repo $SINGULARITY_ALLOWED_DIR/ideal_symblink.sif bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate ideal && python -u /app/repo/idealpestimation/src/icm_annealing_data_slurm.py"
# time singularity exec --bind $WORK:/linkhome/rech/genpuz01/umi36fq,$WORK/ideal/:/app/repo $SINGULARITY_ALLOWED_DIR/ideal_symblink.sif bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate ideal && python -u /app/repo/idealpestimation/src/mle_slurm.py"
# time singularity exec --bind $WORK:/linkhome/rech/genpuz01/umi36fq,$WORK/ideal/:/app/repo $SINGULARITY_ALLOWED_DIR/ideal_symblink.sif bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate ideal && python -u /app/repo/idealpestimation/src/ca_slurm.py"

# time singularity exec --bind $WORK:/linkhome/rech/genpuz01/umi36fq,$WORK/ideal/:/app/repo $SINGULARITY_ALLOWED_DIR/ideal_symblink.sif bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate ideal && python -u /app/repo/idealpestimation/src/aggregate_expI.py"
                                                                                                           
